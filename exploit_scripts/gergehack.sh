#! /bin/sh

#import settings
source /etc/jffs2/gergesettings.txt

cfgfile=/etc/jffs2/anyka_cfg.ini

readline() {
  linetoread=$1
  file=$2
  sed $linetoread'q;d' $file
}

input_wifi_creds() {
  echo 'adding new wifi credentials'
  i=1
  let linecountlimit=$(wc -l < $cfgfile)
  echo "$linecountlimit lines"
  newcredfile=/mnt/anyka_hack/anyka_cfg.ini
  echo -n "" > $newcredfile
  while [ $i -le $linecountlimit ]; do
    line=$(readline $i $cfgfile)
    if [[ "${line:0:4}" == "ssid" ]]; then
      echo "insert $wifi_ssid on line $i"
      echo "ssid = $wifi_ssid">> $newcredfile
    else
      if [[ "${line:0:8}" == "password" ]]; then
        echo "insert $wifi_password on line $i"
        echo "password = $wifi_password">> $newcredfile
      else
        echo "$line">> $newcredfile
      fi
    fi
    let i++
  done
  mv $cfgfile $newcredfile.old
  cp $newcredfile $cfgfile
}

if [[ $run_telnet == 0 ]]; then
  # telnet is started by rc.local or time_zone.sh
  killall telnetd
fi

# check duplicate process
if [[ -f /tmp/exploit.txt ]]; then
  echo 'gergehack is already running'
  # exit if there is already an instance of this script running
#   if ! [[ -f /tmp/exploit1.txt ]]; then
#     echo "exploit">/tmp/exploit1.txt
#     if [[ $run_ipc == 0 ]] && [[ $rootfs_modified == 0 ]]; then
#       #https://github.com/burlizzi/anyka/blob/master/source/daemon/src/daemon.c (line 1935)
#       killall -SIGUSR2 daemon #close watchdog so that anyka_ipc is not restarted
#       killall anyka_ipc.sh # this time it will not be restarted
#       sleep 5
#       killall -SIGTERM daemon
#       if [[ $run_cmd_server == 0 ]]; then
#         killall cmd_serverd
#       fi
#     fi
#   fi
else
  echo "exploit">/tmp/exploit.txt
  if test -e /dev/mmcblk0p1 ;then
    mount -rw /dev/mmcblk0p1 /mnt
  elif test -e /dev/mmcblk0 ;then
    mount -rw /dev/mmcblk0 /mnt
  fi
  echo -e "  _________________________________\n |                                 |\n |       Gerge Hacked This         |\n |_________________________________|"
  #/etc/jffs2/gergedaemon.sh &
  #get new settings from SD card if available
  if [[ -f /mnt/anyka_hack/gergesettings.txt ]]; then
    myresult=$( diff /mnt/anyka_hack/gergesettings.txt /etc/jffs2/gergesettings.txt )
    if [[ ${#myresult} -gt 0 ]]; then
      echo 'install new gergesettings from SD...'
      cp /mnt/anyka_hack/gergesettings.txt /etc/jffs2/gergesettings.txt
      reboot
    fi
  fi
  if [[ -f /mnt/anyka_hack/gergehack.sh ]]; then
    myresult=$( diff /mnt/anyka_hack/gergehack.sh /etc/jffs2/gergehack.sh )
    if [[ ${#myresult} -gt 0 ]]; then
      echo 'install new gergehack from SD...'
      cp /mnt/anyka_hack/gergehack.sh /etc/jffs2/gergehack.sh
      reboot
    fi
  fi
  if [[ $run_cmd_server == 1 ]] && [[ $rootfs_modified == 1 ]]; then
    cmd_serverd
  fi
  if [[ $wifi_start == 1 ]]; then
    setssid=$(grep '^ssid' $cfgfile | sed 's/ //g') #get ssid line and remove spaces
    setpass=$(grep '^password' $cfgfile | sed 's/ //g') #get password line and remove spaces
    setssid=${setssid##*=} #keep the part after the =
    setpass=${setpass##*=} #keep the part after the =
    if ! [[ "$setssid" == "$wifi_ssid" ]]; then
      input_wifi_creds
    else
      if ! [[ "$setpass" == "$wifi_password" ]]; then
        input_wifi_creds
      fi
    fi
    echo '*************  start network service   *************'
    /usr/sbin/wifi_manage.sh start
  fi
  if [[ $run_ftp == 0 ]]; then
    killall tcpsvd
  fi
  if [[ $run_ssh == 1 ]]; then
    echo '*************        start ssh         *************'
    /mnt/anyka_hack/dropbear/dropbearmulti dropbear -r /mnt/anyka_hack/dropbear/dropbear_ecdsa_host_key -B
  fi
  if [[ $run_ptz_daemon == 1 ]] && [[ $run_cmd_server == 1 ]]; then
    echo '*************        start ptz         *************'
    /mnt/anyka_hack/ptz/ptz_daemon &
    if [[ $ptz_init_on_boot == 1 ]]; then
      echo "init_ptz" > /tmp/ptz.daemon
    fi
  fi
  if [[ $run_web_interface == 1 ]]; then # && [[ $run_snapshot == 1 ]]; then
    echo '*************   start web interface    *************'
    /mnt/anyka_hack/web_interface/start_web_interface.sh
  fi
  if [[ $run_rtsp == 1 ]]; then
    echo '*************    start RTSP stream     *************'
    /mnt/anyka_hack/rtsp/stream_video.sh
  else
    if [[ $run_snapshot == 1 ]]; then
      echo '*************     serve snapshots      *************'
      /mnt/anyka_hack/snapshot/snapshot_daemon.sh &
    fi
  fi
  if [[ $run_ipc == 0 ]] && [[ $rootfs_modified == 0 ]]; then
    while [ 1 ]; do
      sleep 30
    done
  fi
fi
