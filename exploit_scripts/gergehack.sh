#! /bin/sh

#import settings
source /etc/jffs2/gergesettings.txt

# check duplicate process
if [[ -f /tmp/exploit.txt ]]; then
  echo 'gergedaemon is already running'
  # exit if there is already an instance of this script running
  if ! [[ -f /tmp/exploit1.txt ]]; then
    echo "exploit">/tmp/exploit1.txt
    if [[ $run_ipc == 0 ]] && [[ $rootfs_modified == 0 ]]; then
      #https://github.com/burlizzi/anyka/blob/master/source/daemon/src/daemon.c (line 1935)
      killall -SIGUSR2 daemon #close watchdog so that anyka_ipc is not restarted
      killall anyka_ipc.sh # this time it will not be restarted
      sleep 5
      killall -SIGTERM daemon
      if [[ $run_cmd_server == 0 ]]; then
        killall cmd_serverd
      fi
    fi
  fi
else
  echo "exploit">/tmp/exploit.txt
  if test -e /dev/mmcblk0p1 ;then
    mount -rw /dev/mmcblk0p1 /mnt
  elif test -e /dev/mmcblk0 ;then
    mount -rw /dev/mmcblk0 /mnt
  fi
  if [[ $run_telnet == 1 ]] && [[ $rootfs_modified == 0 ]]; then
    echo '*************       start telnet       *************'
    busybox telnetd & 
  fi
  echo -e "  _________________________________\n |                                 |\n |       Gerge Hacked This         |\n |_________________________________|"
  /etc/jffs2/gergedaemon.sh &
  if [[ $run_cmd_server == 1 ]] && [[ $rootfs_modified == 1 ]]; then
    cmd_serverd
  fi
  if [[ $wifi_start == 1 ]]; then
    echo '*************  start network service   *************'
    /usr/sbin/wifi_manage.sh start
  fi
  if [[ $run_ssh == 1 ]]; then
    echo '*************        start ssh         *************'
    /mnt/anyka_hack/dropbear/dropbearmulti dropbear -r /mnt/anyka_hack/dropbear/dropbear_ecdsa_host_key -B
  fi
  if [[ $run_snapshot == 1 ]]; then
    echo '*************     serve snapshots      *************'
    /mnt/anyka_hack/snapshot/snapshot_daemon.sh &
  fi
  if [[ $run_ptz_daemon == 1 ]]; then
    echo '*************        start ptz         *************'
    /mnt/anyka_hack/ptz/ptz_daemon &
    if [[ $ptz_init_on_boot == 1 ]]; then
      echo "init" > /tmp/ptz.daemon
    fi
  fi
  if [[ $run_ipc == 0 ]] && [[ $rootfs_modified == 0 ]]; then
    while [ 1 ]; do
      sleep 30
    done
  fi
fi
