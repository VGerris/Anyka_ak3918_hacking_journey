#! /bin/sh

#import settings
source /etc/jffs2/gergesettings.txt

# check duplicate process
if [[ -f /tmp/exploit.txt ]]; then
  echo 'gergedaemon is already running'
  # exit if there is already an instance of this script running
  if [[ -f /tmp/exploit1.txt ]]; then
    echo 'anyka_ipc terminated'
  else
    echo "exploit">/tmp/exploit1.txt
    if [[ $kill_ipc == 1 ]]; then
      #https://github.com/burlizzi/anyka/blob/master/source/daemon/src/daemon.c (line 1935)
      killall -SIGUSR2 daemon #close watchdog so that anyka_ipc is not restarted
      killall anyka_ipc.sh # this time it will not be restarted
      sleep 5
      killall -SIGTERM daemon
      if [[ $kill_cmd_server == 1 ]]; then
        killall cmd_serverd
      fi
    fi
  fi
else
  echo "exploit">/tmp/exploit.txt
  #echo "exploit">/tmp/exploit1.txt
  busybox telnetd &
  echo -e "  _________________________________\n |                                 |\n |       Gerge Hacked This         |\n |_________________________________|"
  /etc/jffs2/gergedaemon.sh &
  if [[ $wifi_start == 1 ]]; then
    echo '*************  start network service   *************'
    /usr/sbin/wifi_manage.sh start
  fi
  if [[ $snapshot_start == 1 ]]; then
    echo '*************     serve snapshots      *************'
    /mnt/anyka_hack/snapshot_daemon.sh &
  fi
  if [[ $ptz_daemon_start == 1 ]]; then
    echo '*************        start ptz         *************'
    /mnt/anyka_hack/ptz/ptz_daemon &
    if [[ $ptz_init_on_boot == 1 ]]; then
      echo "init" >> /tmp/ptz.daemon
    fi
  fi
  if [[ $kill_ipc == 1 ]]; then
    while [ 1 ]; do
      sleep 30
    done
  fi
fi
